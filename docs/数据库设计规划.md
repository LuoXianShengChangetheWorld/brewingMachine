# 智能售酒机平台数据库设计规划

## 一、核心业务表

### 1.1 用户相关表
- **user** - 用户表（已有基础结构）
- **user_role** - 用户角色关联表
- **role** - 角色表（代理商、商家、供应商、运维员、业务员、机主、推广员、消费者等）
- **role_permission** - 角色权限表
- **agent** - 代理商表（继承用户，扩展代理商特有信息）
- **merchant** - 商家表（继承用户，扩展商家特有信息）
- **supplier** - 供应商表
- **operator** - 运营人员表（运维员、业务员）
- **machine_owner** - 机主表
- **promoter** - 推广员表

### 1.2 设备相关表
- **brewing_machine** - 售酒机设备表（已有基础结构）
- **machine_outlet** - 设备出酒口表（每个设备6个出酒口）
- **machine_binding** - 设备绑定表（设备与角色的绑定关系）
- **machine_location** - 设备位置表
- **traffic_card** - 流量卡表
- **traffic_card_binding** - 流量卡绑定表
- **machine_maintenance_log** - 设备运维记录表
- **machine_status_log** - 设备状态记录表（在线/离线/故障/缺电/缺货）

### 1.3 商家店铺相关表
- **store** - 店铺表
- **store_category** - 店铺分类表
- **store_provider** - 店铺提供员关联表
- **store_image** - 店铺图片表

### 1.4 商品相关表
- **wine_category** - 酒类分类表
- **wine** - 酒类商品表
- **wine_spec** - 酒类规格表（规格、套餐等）
- **wine_inventory** - 酒类库存表
- **wine_gold_price** - 酒金价格表（动态价格）

### 1.5 订单相关表
- **order** - 订单表
- **order_item** - 订单明细表
- **recharge_order** - 充值订单表
- **order_payment** - 订单支付记录表

### 1.6 分成相关表
- **commission_rule** - 分成规则表
- **commission_record** - 分成记录表
- **commission_detail** - 分成明细表（日/月/年统计）
- **agent_commission_setting** - 代理商分成设置表
- **merchant_commission_setting** - 商家分成设置表
- **store_commission_setting** - 店铺分成设置表
- **machine_commission_setting** - 设备分成设置表

### 1.7 营销活动相关表
- **coupon** - 优惠券表
- **coupon_template** - 优惠券模板表
- **user_coupon** - 用户优惠券表
- **red_packet_pool** - 红包池表
- **red_packet_record** - 红包领取记录表
- **red_packet_recharge_code** - 红包充值码表
- **vip_card** - VIP卡表
- **vip_card_user** - 用户VIP卡表
- **promotion_activity** - 促销活动表
- **lottery_activity** - 抽奖活动表
- **lottery_prize** - 抽奖奖品表

### 1.8 支付相关表
- **payment** - 支付记录表
- **withdrawal** - 提现记录表
- **withdrawal_account** - 提现账户表（银行卡/支付宝/微信）

### 1.9 二维码相关表
- **qr_code_login** - 二维码登录表（已有）
- **qr_code_role_auth** - 角色授权二维码表

### 1.10 统计相关表
- **statistics_daily** - 日统计表
- **statistics_monthly** - 月统计表
- **statistics_yearly** - 年统计表

### 1.11 其他功能表
- **advertisement** - 广告表
- **advertisement_view_log** - 广告观看记录表
- **system_config** - 系统配置表

## 二、关键字段设计要点

### 2.1 用户表扩展字段
- 用户类型（role_type）
- 上级用户ID（parent_user_id）- 用于层级关系
- 分成比例设置
- 累计营业额/消费额
- 账户余额
- 积分余额
- 礼金余额
- 酒金余额

### 2.2 设备表扩展字段
- 设备编号（唯一）
- 设备状态（在线/离线/故障/缺电/缺货）
- 绑定状态
- 当前位置
- 流量卡ID
- 电量信息
- 二维码内容（动态生成）

### 2.3 订单表字段
- 订单类型（销售订单/充值订单）
- 订单来源（酒机/店铺/小程序）
- 支付方式（现金/扫码/余额/积分/券/礼金/酒金）
- 订单金额
- 实际支付金额
- 折扣金额
- 使用券金额
- 分成金额
- 订单状态

### 2.4 分成记录表字段
- 分成来源（订单ID）
- 分成类型（代理商/商家/供应商/机主/推广员等）
- 分成角色ID
- 分成比例
- 分成金额
- 分成层级
- 统计周期（日/月/年）

### 2.5 红包池表字段
- 红包池类型（商家/角色/消费者）
- 所属ID（商家ID/角色ID/用户ID）
- 总金额
- 剩余金额
- 已领取金额
- 充值金额
- 累计营业额（用于计算红包额度）

## 三、层级关系设计

### 3.1 代理商层级
- 使用 parent_user_id 建立树形结构
- 支持多级代理（省代->市代->区代->社区代）
- 每个层级有独立的分成比例设置

### 3.2 设备绑定层级
- 设备可以绑定多个角色
- 每个角色有不同的分成比例
- 分成按商家让利后的百分比计算
- 支持一个设备的多个出酒口绑定不同的供应商

### 3.3 推广员绑定关系
- 推广员与用户的绑定关系
- 推广员与商家的绑定关系
- 推广员与设备的绑定关系

## 四、数据统计设计

### 4.1 实时统计
- 使用视图或查询实时计算

### 4.2 汇总统计表
- 按日/月/年维度预先计算统计结果
- 定期任务更新统计数据
- 支持按角色、设备、商家等维度统计

## 五、关键业务规则实现

### 5.1 分成计算规则
- 订单完成后触发分成计算
- 按照层级关系逐级计算分成
- 记录每级的分成明细
- 支持分成比例动态调整

### 5.2 红包额度计算
- 商家红包：根据商家累计营业额计算
- 角色红包：根据角色负责关系链的累计营业额计算
- 消费者红包：根据消费者累计消费额计算
- 支持手动调整红包额度

### 5.3 酒金价格计算
- 根据酒的销售量动态调整
- 支持手动设置
- 记录价格变更历史

### 5.4 设备状态管理
- 实时监控设备状态
- 记录状态变更历史
- 支持告警和通知

