# 数据库设计优化说明

## 变更概述

为提高数据库设计的简洁性和一致性，我们对智能售酒机平台的数据库设计进行了优化。主要变更如下：

### 1. 代理商模块设计优化

#### 原设计问题

- **角色重复定义**：在`role`表中定义了代理商角色，同时又创建了独立的`agent`表
- **数据分散**：代理商基本信息分散在`user`、`role`、`user_role`和`agent`表中
- **维护复杂性**：需要维护多套关联关系，增加了查询和更新的复杂度

#### 新设计方案

我们将代理相关的业务字段整合到用户表中，实现了基于角色的代理管理：

```sql
-- 用户表
CREATE TABLE IF NOT EXISTS `user` (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) COMMENT '密码（加密存储）',
    nickname VARCHAR(100) COMMENT '昵称',
    phone VARCHAR(20) COMMENT '手机号',
    email VARCHAR(100) COMMENT '邮箱',
    avatar VARCHAR(500) COMMENT '头像URL',
    gender TINYINT DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    status TINYINT DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    parent_user_id BIGINT COMMENT '上级用户ID（用于层级关系）',
    
    -- 代理相关业务字段
    agent_level VARCHAR(50) COMMENT '代理级别：PROVINCE-省代，CITY-市代，DISTRICT-区代，COMMUNITY-社区代',
    total_turnover DECIMAL(12, 2) DEFAULT 0.00 COMMENT '总营业额',
    total_commission DECIMAL(12, 2) DEFAULT 0.00 COMMENT '总分成',
    sub_agent_count INT DEFAULT 0 COMMENT '下级代理数量',
    commission_rate DECIMAL(5, 2) COMMENT '分成比例（百分比）',
    
    -- 用户财务相关字段
    balance DECIMAL(10, 2) DEFAULT 0.00 COMMENT '账户余额',
    points BIGINT DEFAULT 0 COMMENT '积分余额',
    gift_money DECIMAL(10, 2) DEFAULT 0.00 COMMENT '礼金余额',
    wine_gold DECIMAL(10, 2) DEFAULT 0.00 COMMENT '酒金余额',
    total_consumption DECIMAL(10, 2) DEFAULT 0.00 COMMENT '累计消费额',
    
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_time DATETIME COMMENT '最后登录时间',
    INDEX idx_username (username),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    INDEX idx_parent_user_id (parent_user_id),
    INDEX idx_agent_level (agent_level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 主要变更

1. **删除了独立的`agent`表**
2. **将代理相关字段添加到用户表中**：
   - `agent_level`：代理级别
   - `total_turnover`：总营业额
   - `total_commission`：总分成
   - `sub_agent_count`：下级代理数量
   - `commission_rate`：分成比例
3. **修改了相关表的外键约束**：
   - `agent_commission_detail`表的`agent_id`字段改为`user_id`，直接关联用户表
   - `agent_invite_qrcode`表的`inviter_agent_id`字段改为`inviter_user_id`，直接关联用户表

## 设计优势

### 1. 简化数据模型

- 减少了表的数量和相关关系
- 消除了角色与代理商信息的重复定义
- 数据存储更加集中，便于维护

### 2. 提高数据一致性

- 代理商基本信息与用户信息保存在同一表中，避免数据分散
- 角色权限通过`user_role`关联表统一管理
- 减少了关联查询的复杂度

### 3. 增强系统可扩展性

- 更容易添加新的代理级别和业务规则
- 可以方便地扩展其他角色的业务字段
- 便于实现基于角色的权限控制（RBAC）

### 4. 提升查询效率

- 减少了表之间的JOIN操作
- 单一表查询代理商信息更加高效
- 统计汇总更加直接

## 对系统的影响

### 1. 代码修改

- 需要更新所有引用`agent`表的代码，改为查询用户表
- 修改代理商相关的业务逻辑，直接使用用户表中的代理字段
- 更新权限验证逻辑，通过用户角色进行权限控制

### 2. 数据迁移

- 需要将`agent`表中的数据迁移到用户表中
- 保持外键关系的一致性
- 执行数据一致性检查

### 3. API调整

- 代理商相关的API接口需要调整参数和返回值
- 更新文档说明新的数据结构和接口

## 总结

通过将代理商信息整合到用户表中，我们简化了数据库设计，提高了数据一致性和系统性能。这种设计符合RBAC（基于角色的访问控制）的最佳实践，使系统更加清晰和可维护。