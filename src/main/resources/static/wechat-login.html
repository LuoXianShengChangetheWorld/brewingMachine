<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信登录 - 智能售酒机平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #07c160 0%, #06ae56 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #07c160 0%, #06ae56 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-methods {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .login-btn {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .wechat-btn {
            background: #07c160;
            color: white;
        }

        .wechat-btn:hover {
            background: #06ae56;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.4);
        }

        .qrcode-btn {
            background: #f5f5f5;
            color: #333;
        }

        .qrcode-btn:hover {
            background: #e8e8e8;
            transform: translateY(-2px);
        }

        .btn-icon {
            width: 24px;
            height: 24px;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 25px 0;
            color: #999;
            font-size: 14px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .divider span {
            padding: 0 15px;
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            display: none;
        }

        .result-container.success {
            display: block;
            background: #f0f9eb;
            border: 1px solid #c2e7b0;
        }

        .result-container.error {
            display: block;
            background: #fef0f0;
            border: 1px solid #fbc4c4;
        }

        .result-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .result-container.success .result-icon {
            background: #07c160;
            color: white;
        }

        .result-container.error .result-icon {
            background: #f56c6c;
            color: white;
        }

        .result-message {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .result-details {
            font-size: 14px;
            color: #666;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            font-size: 14px;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #07c160;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tips {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
            text-align: left;
        }

        .tips-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }

        .tips-list {
            list-style: none;
            padding: 0;
        }

        .tips-list li {
            padding: 3px 0;
            padding-left: 20px;
            position: relative;
        }

        .tips-list li::before {
            content: '•';
            position: absolute;
            left: 5px;
            color: #07c160;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">酒</div>
        <h1>智能售酒机平台</h1>
        <p class="subtitle">欢迎登录管理后台</p>

        <div id="loginMethods" class="login-methods">
            <button class="login-btn wechat-btn" onclick="wechatLogin()">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 0 1 .213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.326.326 0 0 0 .167-.054l1.903-1.114a.864.864 0 0 1 .717-.098 10.16 10.16 0 0 0 2.837.403c.276 0 .543-.027.811-.05-.857-2.578.157-4.972 1.932-6.446 1.703-1.415 3.882-1.98 5.853-1.838-.576-3.583-4.196-6.348-8.596-6.348zM5.785 5.991c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178A1.17 1.17 0 0 1 4.623 7.17c0-.651.52-1.18 1.162-1.18zm5.813 0c.642 0 1.162.529 1.162 1.18a1.17 1.17 0 0 1-1.162 1.178 1.17 1.17 0 0 1-1.162-1.178c0-.651.52-1.18 1.162-1.18zm5.34 2.867c-1.797-.052-3.746.512-5.28 1.786-1.72 1.428-2.687 3.72-1.78 6.22.942 2.453 3.666 4.229 6.884 4.229.826 0 1.622-.12 2.361-.336a.722.722 0 0 1 .598.082l1.584.926a.272.272 0 0 0 .14.047c.134 0 .24-.111.24-.247 0-.06-.023-.12-.038-.177l-.327-1.233a.582.582 0 0 1-.023-.156.49.49 0 0 1 .201-.398C23.024 18.48 24 16.82 24 14.98c0-3.21-2.931-5.837-6.656-6.088V8.89l-.406-.033zm-2.635 3.263c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.97-.982zm4.844 0c.535 0 .969.44.969.982a.976.976 0 0 1-.969.983.976.976 0 0 1-.969-.983c0-.542.434-.982.969-.982z"/>
                </svg>
                微信登录
            </button>

            <div class="divider"><span>或</span></div>

            <button class="login-btn qrcode-btn" onclick="showQrCodeLogin()">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm8-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm13-2h3v3h-3v-3zm-3 0h3v3h-3v-3zm0 6h3v3h-3v-3zm3-3h3v3h-3v-3zm0 6h3v3h-3v-3zm-6 3h3v3H8v-3zm3 0h3v3h-3v-3zm0-6h3v3H8v-3zm3 3h3v3h-3v-3zm3 0h3v3h-3v-3z"/>
                </svg>
                二维码登录
            </button>
        </div>

        <div id="loadingContainer" class="result-container" style="display: none;">
            <div class="loading"></div>
            <p style="margin-top: 15px; color: #666;">正在跳转微信授权...</p>
        </div>

        <div id="resultContainer" class="result-container">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-message" id="resultMessage"></div>
            <div class="result-details" id="resultDetails"></div>
            <div class="user-info" id="userInfo" style="display: none;">
                <img class="user-avatar" id="userAvatar" src="" alt="头像">
                <span class="user-name" id="userName"></span>
            </div>
        </div>

        <div class="tips">
            <div class="tips-title">登录说明</div>
            <ul class="tips-list">
                <li>微信扫码登录需要先在微信开放平台注册应用</li>
                <li>请确保配置的AppID和AppSecret正确</li>
                <li>回调地址需要与微信开放平台配置一致</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = '/api/wechat';

        async function wechatLogin() {
            try {
                document.getElementById('loginMethods').classList.add('hidden');
                document.getElementById('loadingContainer').style.display = 'block';
                document.getElementById('resultContainer').className = 'result-container';

                const response = await fetch(API_BASE + '/auth/url');
                const data = await response.json();

                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    throw new Error('获取授权地址失败');
                }
            } catch (error) {
                console.error('微信登录失败:', error);
                showResult(false, '登录失败', error.message);
            }
        }

        function showQrCodeLogin() {
            window.location.href = '/index.html';
        }

        function showResult(success, message, details) {
            document.getElementById('loginMethods').classList.add('hidden');
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('resultContainer').className = 'result-container ' + (success ? 'success' : 'error');

            document.getElementById('resultIcon').textContent = success ? '✓' : '✗';
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('resultDetails').textContent = details || '';

            if (success && window.userInfo) {
                const userInfoDiv = document.getElementById('userInfo');
                document.getElementById('userAvatar').src = window.userInfo.avatar || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="%23ccc"/></svg>';
                document.getElementById('userName').textContent = window.userInfo.nickname || '用户';
                userInfoDiv.style.display = 'flex';

                localStorage.setItem('token', window.userInfo.token);
                localStorage.setItem('userId', window.userInfo.userId);
                localStorage.setItem('userInfo', JSON.stringify(window.userInfo));
            }
        }

        function checkLoginStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const error_description = urlParams.get('error_description');

            if (error) {
                showResult(false, '授权失败', error_description || error);
                return;
            }

            if (code) {
                handleCallback(code, state);
            }
        }

        async function handleCallback(code, state) {
            try {
                document.getElementById('loginMethods').classList.add('hidden');
                document.getElementById('loadingContainer').style.display = 'block';

                const response = await fetch(API_BASE + '/callback?code=' + code + '&state=' + (state || ''));
                const data = await response.json();

                if (data.success) {
                    window.userInfo = {
                        token: data.token,
                        userId: data.userId,
                        nickname: data.nickname,
                        avatar: data.avatar,
                        isNewUser: data.isNewUser
                    };

                    const message = data.isNewUser ? '注册成功，欢迎使用！' : '登录成功，欢迎回来！';
                    showResult(true, message, '正在跳转...');

                    setTimeout(() => {
                        window.location.href = '/dashboard.html';
                    }, 1500);
                } else {
                    showResult(false, '登录失败', data.message);
                }
            } catch (error) {
                console.error('处理回调失败:', error);
                showResult(false, '登录失败', error.message);
            }
        }

        function getQueryString(name) {
            const reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)');
            const r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }

        window.onload = function() {
            checkLoginStatus();
        };
    </script>
</body>
</html>
